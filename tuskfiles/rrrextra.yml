---
usage: "generate the extradata hex string for the rrr genesis document"
options:
  showids:
    short: "i"
    type: bool

args:
  configdir:
    usage: >
      The config root directory.
run:
  - task:
      name: configure
      args:
        - ${configdir}

  - command:
      exec: |
        set -e
        CONFIGVARS="${configvars} gendoc_extra gendoc_wallet gendoc_balance"
        eval ${READ_CONFIG}
        if ${configshow}; then eval ${SHOW_CONFIG}; exit 0; fi
        cd ${launchdir} && cd ${configdir}

        # we cd to run the rrr tool, so these need to be absoloute
        nodesdir=$(cd ${nodesdir} && pwd)
        node0dir=${nodesdir}/node0

        SHOWIDS=""
        ${showids} && SHOWIDS="--showids"

        ALPHAS=""
        for n in $(seq 0 $((${maxnodes} - 1))); do
          ALPHAS="$ALPHAS ${nodesdir}/node${n}/alpha.json"
        done

        cd ${rrr_src}/tools

        EXTRADATA=$(go run cmd/rrrctl/main.go genextra \
            ${SHOWIDS} --datadir ${node0dir} $ALPHAS)

        cat <<PYEND | python3
        import os, sys, json
        j = None
        with open("bench.json") as f:
            j = json.load(f)
        if j is None:
            sys.exit(-1)
        j["gendoc_extra"] = os.environ["EXTRADATA"]
        with open("bench.json", "w") as f:
            json.dump(j, f, indent=2, sort_keys=True)
        PYEND
        echo $EXTRADATA
