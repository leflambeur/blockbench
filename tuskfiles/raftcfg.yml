---
usage: "inititialise for geth/raft. for any options that have no help, please see the top level raft command"
args:
  configdir:
    usage: >
      The config root directory.
options:

  name:
    default: ""

  nodesdir:
    usage: "relative to configdir. each node gets a subdirectory here named node{N}"
    default: nodes

  genesis:
    default: "genesis-in.json"

  raft_blocktime:
    usage: |
      the --raftblocktime cosensus parameter for starting geth (ms)
    default: 50

  recommit:
    usage: "sets the --miner.recommit option for the nodes."
    default: ""

  # these declarations duplicate the global options in the parent tusk. because
  # otherwise they can't be supplied to  - task: subcommands
  geth_image:
  delve_image:
  quorum_src:
  maxnodes:
  gendoc_wallet:
  nodeallocs:

run:
  - command:
      exec: |
        set -e

        TUSKDIR=$(pwd)

        cd ${launchdir} && mkdir -p ${configdir} && cd ${configdir}
        mkdir -p ${nodesdir}/node0

        # we don't allow this to be set on the cli, if you want another
        # env thats fine, just edit bench.json afterwords to point to yours
        # and make sure you install the requirements.txt
        pyenv="env"

        echo "Initialising in: $(pwd)"

        python3 -m venv ${pyenv}
        source ${pyenv}/bin/activate
        pip3 install -r ${TUSKDIR}/requirements.txt

        NAME="${name}"
        [ -z ${NAME} ] && NAME="raft${maxnodes}"

        PYENVDIR=$(cd ${pyenv} && pwd)
        # generate the config from the options
        cat <<JEND  > bench.json
        {
          "name": "${NAME}",
          "pyenv": "${PYENVDIR}",
          "maxnodes": "${maxnodes}",
          "nodesdir": "$(pwd)/${nodesdir}",
          "quorum_src": "${quorum_src}",
          "geth_image": "${geth_image}",
          "delve_image": "${delve_image}",
          "genesis": "${genesis}",
          "gendoc_wallet": "${gendoc_wallet}",
          "nodeallocs": "${nodeallocs}",
          "gendoc_balance": "${gendoc_balance}",
          "raft_blocktime": "${raft_blocktime}",
          "timestamp_scale": "1000000000"
        }
        JEND

        cat bench.json
        echo "Wrote: $(pwd)/bench.json"
