---
usage: "rrr genesis - keeps existing keys and alpha contributions"
options:
  sudo:
    type: bool
  genesisfor:
    default: raft
  extradata:
    default: ""

  mixhash:
    usage: >
      for ibft set this to 0x63746963616c2062797a616e74696e65206661756c7420746f6c6572616e6365
    default: ""
  chainid:
    default: "12345678"

args:
  configdir:
    usage: >
      The config root directory.
run:
  - task:
      name: configure
      args:
        - ${configdir}
  - command:
      exec: |
        set -e

        TUSKDIR=$(pwd)

        CONFIGVARS="${configvars} gendoc_extra"
        eval ${READ_CONFIG}
        if ${configshow}; then eval ${SHOW_CONFIG}; exit 0; fi
        cd ${launchdir} && cd ${configdir}

        EXTRADATA="${extradata}"
        [ -n "${EXTRADATA}" ] && EXTRADATA=${gendoc_extra}
        [ -n "${EXTRADATA}" ] && EXTRADATA=""

        CONFIGDIR=$(pwd)

        cp ${TUSKDIR}/compose/${genesisfor}/genesis-in.json .

        pushd ${launchdir} # restore launchdir before recursive invoke
          tusk -qf ${thistusk} gethgendoc ${configdir} --extra "$EXTRADATA" | tee ${CONFIGDIR}/genesis.json
        popd

        # clear out all the data dirs first to avoid mixed state if we fail
        # half way through
        ${sudo} && dosudo="sudo" || dosudo=""

        end=$((maxnodes - 1))
        for i in $(seq 0 ${end}); do
          ${dosudo} rm -rf ${nodesdir}/node$i/data
        done

        for i in $(seq 0 ${end}); do
          rm -rf ${nodesdir}/node$i/data
        done

        genesis_doc=$(pwd)/genesis.json
        for i in $(seq 0 ${end}); do
          geth="docker run --rm -u $(id -u):$(id -g) -v $(pwd):$(pwd) ${geth_image} --nousb"
          ${geth} \
              --datadir=$(pwd)/nodes/node${i}/data  \
              --nodekey $(pwd)/nodes/node${i}/key \
              init $(pwd)/genesis.json
        done
