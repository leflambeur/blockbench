name: loadtest-on-gcp
on:
  workflow_call:
    inputs:
      project_id:
        description: 'GCP project id (usualy project_name-NUMBER generated by gcp for you)'
        type: string
        required: true
      location:
        description: 'Kubernetes Engine cluster location'
        type: string
        required: true
      cluster_name:
        description: 'Kubernetes Engine cluster name'
        type: string
        required: true
      consensus:
        description: 'The name of a consensus scheme supported by blockbench. Eg, raft ibft or rrr'
        type: string
        default: 'raft'
      numnodes:
        description: 'number of nodes required in the network'
        type: number
        default: 5
      profile:
        description: 'name of a blockbench profile ({consensus}-k8s-{profile}.json in blockbench/configs). defaults to numnodes'
        type: string
    secrets:
      gcp_project_key:
        description: >
          GCP service account key with the appropriate roles for applying k8s manifests. Typically
          created in the google cloud console. Eg.,
          IAM & Admin / Service Accounts -> Compute Engine Default Service account -> create key -> create as json
        required: true
jobs:
  loadtest-on-gcp:
    name: loadtest-on-gcp
    runs-on: ubuntu-latest
    steps:

      - id: create-network-manifests
        container: robinbryce/bbench:main
        args:
          - new
          - --k8s
          - --maxnodes ${{ inputs.numnodes }}
          - --profile ${{ inputs.numnodes }}
          - networks/${{ inputs.consensus }}${{ inputs.numnodes }}
          - ${{ inputs.consensus }}

      - id: pre-deploy
        run: |
          tree networks/${{ inputs.consensus }}${{ inputs.numnodes }}

      - id: get-credentials
        uses: google-github-actions/get-gke-credentials@main
        with:
          cluster_name: ${{ inputs.cluster_name }}
          location: ${{ inputs.location }}
          project_id: ${{ inputs.project_id }}
          credentials: ${{ secrets.gcp_project_key }}

      # The KUBECONFIG env var is automatically exported and picked up by kubectl.
      - id: get-pods
        run: kubectl get pods

